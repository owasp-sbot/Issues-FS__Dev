;; =============================================================================
;; claude-sandbox.sb — macOS Sandbox Profile for Claude.app
;; =============================================================================
;; Restricts Claude.app's filesystem access to explicitly listed directories.
;; This uses macOS's built-in sandbox-exec mechanism.
;;
;; Usage:
;;   sandbox-exec -f claude-sandbox.sb /Applications/Claude.app/Contents/MacOS/Claude
;; =============================================================================

(version 1)

;; Start with deny-all, then allow specific things
(deny default)

;; ---- Allow basic process operations ----------------------------------------
(allow process-exec)
(allow process-fork)
(allow signal)
(allow sysctl-read)
(allow mach-lookup)
(allow mach-register)
(allow ipc-posix-shm-read-data)
(allow ipc-posix-shm-write-data)
(allow ipc-posix-shm-read-metadata)
(allow ipc-posix-shm-write-create)
(allow ipc-posix-shm-write-unlink)

;; ---- Allow GUI operations (WindowServer, CoreGraphics, etc.) ---------------
(allow iokit-open)
(allow iokit-get-properties)
(allow user-preference-read)
(allow file-read-metadata)

;; ---- System libraries and frameworks (read-only) ---------------------------
(allow file-read*
    (subpath "/System")
    (subpath "/Library")
    (subpath "/usr/lib")
    (subpath "/usr/share")
    (subpath "/private/var/db")
    (subpath "/dev")
    (subpath "/Applications/Claude.app")
    (subpath "/bin")
    (subpath "/usr/bin")
    (subpath "/sbin")
    (subpath "/usr/sbin")
)

;; ---- Allow Claude.app to function (Electron needs these) -------------------
;; User-level Library (fonts, preferences, caches for the app itself)
(allow file-read*
    (subpath (string-append (param "HOME") "/Library/Preferences"))
    (subpath (string-append (param "HOME") "/Library/Caches/Claude"))
    (subpath (string-append (param "HOME") "/Library/Application Support/Claude"))
    (subpath (string-append (param "HOME") "/Library/Saved Application State/com.anthropic.claudefordesktop.savedState"))
)

(allow file-write*
    (subpath (string-append (param "HOME") "/Library/Caches/Claude"))
    (subpath (string-append (param "HOME") "/Library/Application Support/Claude"))
    (subpath (string-append (param "HOME") "/Library/Saved Application State/com.anthropic.claudefordesktop.savedState"))
    (subpath (string-append (param "HOME") "/Library/Logs/Claude"))
)

;; Temp directories
(allow file-read* file-write*
    (subpath "/private/tmp")
    (subpath "/private/var/folders")
    (subpath (string-append (param "HOME") "/Library/Caches/com.anthropic.claudefordesktop"))
)

;; ---- NETWORK (required for Claude API communication) -----------------------
(allow network-outbound)
(allow network-inbound (local ip))
(allow system-socket)

;; =============================================================================
;; PROJECT ACCESS — EDIT THESE TO MATCH YOUR SETUP
;; =============================================================================

;; ---- Read/Write: Project directories ---------------------------------------
(allow file-read* file-write*
    (subpath "/Users/diniscruz/_dev/owasp-sbot/Issues-FS__Dev")
)

;; ---- Read-Only: Virtual environments, SDKs, tools -------------------------
(allow file-read*
    (subpath "/Users/diniscruz/Library/Caches/pypoetry/virtualenvs/issues-fs-dev-1uzJze9o-py3.12")
)

;; ---- Executables that Claude Code spawns -----------------------------------
;; Allow executing specific tools (read + execute)
(allow file-read* process-exec
    (subpath "/usr/bin")
    (subpath "/usr/local/bin")
    (subpath "/bin")
    (subpath "/opt/homebrew/bin")
    (subpath "/opt/homebrew/Cellar")
)

;; Allow executing the venv python
(allow process-exec
    (subpath "/Users/diniscruz/Library/Caches/pypoetry/virtualenvs/issues-fs-dev-1uzJze9o-py3.12")
)

;; ---- Node.js (required for Claude Code runtime) ----------------------------
;; Uncomment and adjust for your Node.js installation:
;; (allow file-read* process-exec (subpath "/Users/diniscruz/.nvm"))
;; (allow file-read* process-exec (subpath "/usr/local/lib/node_modules"))
;; (allow file-read* process-exec (subpath "/opt/homebrew/lib/node_modules"))

;; =============================================================================
;; EXPLICITLY DENIED — these are already denied by default, listed for clarity
;; =============================================================================
;; /Users/diniscruz/.ssh              — SSH keys
;; /Users/diniscruz/.zsh_history      — shell history
;; /Users/diniscruz/Desktop           — personal files
;; /Users/diniscruz/Documents         — personal files
;; /Users/diniscruz/Downloads         — personal files
;; /Users/diniscruz/.env              — environment credentials
;; /Users/diniscruz/.gitconfig        — git credentials (global)
;; Any other project directories      — lateral movement
