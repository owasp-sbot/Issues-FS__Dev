;; =============================================================================
;; claude-sandbox.sb — macOS Sandbox Profile for Claude.app
;; =============================================================================
;; Strategy: ALLOW by default, DENY access to sensitive paths.
;;
;; A deny-default profile is impractical for Electron apps (Chromium touches
;; hundreds of system paths at startup). Instead, we allow normal operation
;; but explicitly block access to directories that Claude should never touch.
;;
;; Usage:
;;   sandbox-exec -f claude-sandbox.sb -D HOME=/Users/diniscruz \
;;     /Applications/Claude.app/Contents/MacOS/Claude
;; =============================================================================

(version 1)

;; Start permissive — Electron/Chromium needs broad system access to function
(allow default)

;; =============================================================================
;; DENY LIST — paths Claude.app must NOT access
;; =============================================================================

;; ---- SSH keys and credentials ----------------------------------------------
(deny file-read* file-write*
    (subpath (string-append (param "HOME") "/.ssh"))
    (literal (string-append (param "HOME") "/.aws/credentials"))
    (literal (string-append (param "HOME") "/.aws/config"))
    (subpath (string-append (param "HOME") "/.gnupg"))
)

;; ---- Shell history and configs (credential leakage) ------------------------
(deny file-read*
    (literal (string-append (param "HOME") "/.zsh_history"))
    (literal (string-append (param "HOME") "/.bash_history"))
    (literal (string-append (param "HOME") "/.node_repl_history"))
    (literal (string-append (param "HOME") "/.python_history"))
)

;; ---- Personal directories --------------------------------------------------
(deny file-read* file-write*
    (subpath (string-append (param "HOME") "/Desktop"))
    (subpath (string-append (param "HOME") "/Documents"))
    (subpath (string-append (param "HOME") "/Downloads"))
    (subpath (string-append (param "HOME") "/Pictures"))
    (subpath (string-append (param "HOME") "/Movies"))
    (subpath (string-append (param "HOME") "/Music"))
)

;; ---- Other dev projects (prevent lateral movement) -------------------------
;; Block the entire _dev tree, then carve out the allowed project below.
;; NOTE: Order matters in sandbox profiles — later rules override earlier ones.
;; Unfortunately macOS sandbox does NOT support deny-then-allow overrides.
;; So instead we deny specific sibling projects / parent dirs we want blocked.
;;
;; Option A: Block specific known sibling dirs (safer, more maintenance)
;; Option B: Don't block _dev broadly, rely on the personal dirs block above
;;
;; Using Option B by default. Uncomment Option A entries if you have specific
;; projects to block:
;;
;; (deny file-read* file-write*
;;     (subpath (string-append (param "HOME") "/_dev/other-project"))
;;     (subpath (string-append (param "HOME") "/_dev/secrets"))
;; )

;; ---- Environment files that may contain secrets ----------------------------
(deny file-read*
    (literal (string-append (param "HOME") "/.env"))
    (literal (string-append (param "HOME") "/.npmrc"))
    (literal (string-append (param "HOME") "/.pypirc"))
    (literal (string-append (param "HOME") "/.netrc"))
    (literal (string-append (param "HOME") "/.docker/config.json"))
)

;; ---- Keychains (macOS credential store) ------------------------------------
(deny file-read* file-write*
    (subpath (string-append (param "HOME") "/Library/Keychains"))
)

;; =============================================================================
;; NOTES
;; =============================================================================
;; What IS allowed (by the default allow rule):
;;   - /Users/diniscruz/_dev/owasp-sbot/Issues-FS__Dev  (R/W — your project)
;;   - /Users/diniscruz/Library/Caches/pypoetry/...     (R/O effectively)
;;   - All system paths, executables, frameworks
;;   - Network access (required for Claude API)
;;   - Claude.app's own support directories
;;
;; What is BLOCKED:
;;   - ~/.ssh, ~/.gnupg, ~/.aws — credentials
;;   - Shell histories — credential/secret leakage
;;   - ~/Desktop, ~/Documents, ~/Downloads, etc. — personal files
;;   - ~/.env, ~/.npmrc, ~/.netrc, etc. — secret env files
;;   - ~/Library/Keychains — macOS keychain
;;
;; To add more blocked paths, add (deny file-read* file-write* ...) entries.
;; To block a specific sibling project:
;;   (deny file-read* file-write* (subpath "/Users/diniscruz/_dev/other-project"))
